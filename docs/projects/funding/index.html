
<!-- 

  TODO:
  - add swoopy arrows to visualization [check]
  - add tooltip: hover (amount, deviation from average) [check]
  - add switch between absolute and relative values [check]
  - calculate relative funding / yearwise [check]
  - check scaling [check]
  - add highlighting (vertical / horizontal) [check]
  - add timeline [check]

  - style introduction and reading direction
  - add legend for circle size (a flexible one) !!!!
  - make the chart responsive [half-check]
  - recreate dataset with fuzzy merging
  - write annotations (check with sebastian)

 -->

<!doctype html>
<html lang="de" itemscope itemtype="http://schema.org/Article">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Berliner Zuwendungsdaten | Ideation &amp; Prototyping Lab</title>
        <meta name="description" content="{{PROJECT_DESCRIPTION_DE}}">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <link type="text/plain" rel="author" href="../../humans.txt" />
        <link rel="manifest" href="../../site.webmanifest">
        <link rel="apple-touch-icon" href="../../icons/icon.png">

        <link rel="icon" type="image/png" href="../../icons/favicon-alpha-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="../../icons/favicon-alpha-96x96.png" sizes="96x96">
        <link rel="shortcut icon" type="image/x-icon" href="../../favicon.ico">

        <meta name="generator" content="NodeJS,GRUNT">
        <meta name="robots" content="index, follow">
        <link rel="alternate" type="application/rss+xml" title="Ideation &amp; Prototyping Lab | Feed" href="http://lab.technologiestiftung-berlin.de/feed.xml" />
        <meta http-equiv="content-language" content="de">

        <!-- FACEBOOK -->
        <meta property="fb:app_id" content="487094758334595">
        <meta property="og:url" content="http://lab.technologiestiftung-berlin.de/projects/funding/index.html">
        <meta property="og:type" content="website">
        <meta property="og:title" content="{{PROJECT_TITLE_DE}}">
        <meta property="og:image" content="http://lab.technologiestiftung-berlin.de/projects/funding/social_media.jpg">
        <meta property="og:description" content="{{PROJECT_DESCRIPTION_DE}}">
        <meta property="og:site_name" content="Ideation &amp; Prototyping Lab">
        <meta property="article:author" content="Fabian Dinklage">

        <!-- TWITTER -->
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@TSBBerlin">
        <meta name="twitter:creator" content="fdnklg">
        <meta name="twitter:url" content="http://lab.technologiestiftung-berlin.de/projects/funding/index.html">
        <meta name="twitter:title" content="{{PROJECT_TITLE_DE}}">
        <meta name="twitter:description" content="{{PROJECT_DESCRIPTION_DE}}">
        <meta name="twitter:image" content="http://lab.technologiestiftung-berlin.de/projects/funding/social_media.jpg">

        <!-- GOOGLE+/SCHEMA.ORG -->
        <meta itemprop="name" content="{{PROJECT_TITLE_DE}}">
        <meta itemprop="description" content="{{PROJECT_DESCRIPTION_DE}}">
        <meta itemprop="image" content="http://lab.technologiestiftung-berlin.de/projects/funding/social_media.jpg">

        <!-- CANONICAL URL -->
        <link rel="canonical" href="http://lab.technologiestiftung-berlin.de/projects/funding/index.html">
        <!--<link rel="shortlink" href="tsblab.de/projects/PROJECT">-->

        <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:300,300i|Barlow:400,400i,700,700i" rel="stylesheet">
        <meta name="theme-color" content="#1e3791">
        <link href="../../js/prism/prism.css" rel="stylesheet" />
        <link rel="stylesheet" href="../../css/style.css">
				<link rel="stylesheet" href="./style.css">
    </head>
    <body class="project">
        <header id="page-head">
            <div class="container">
                <div class="left">
                    <div id="minilogo"><svg viewBox="0 0 254 190" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(-1875.000000, -2479.000000)" stroke-linecap="round" stroke-linejoin="round"><g transform="translate(1875.000000, 2478.000000)" fill="#000000" fill-rule="nonzero" stroke-width="7"><g id="logo" transform="translate(128.500000, 100.500000) rotate(4.000000) translate(-128.500000, -100.500000) translate(7.000000, 9.000000)"><path d="M0.316967317,116.55394 L61.6724044,179.221053" stroke="#6ECDF5"></path><path d="M61.6724044,179.221053 L232.546021,4.8771611" stroke="#6ECDF5"></path><path d="M0.316967317,116.55394 L233.101334,4.23466223" stroke="#6ECDF5"></path><path d="M1.51109571,116.469957 L203.326978,154.172387" stroke="#6ECDF5"></path><path d="M233.101334,4.23466223 L203.285227,153.57188" stroke="#6ECDF5"></path><path d="M203.924042,154.130395 L239.525752,116.998677" stroke="#6ECDF5"></path><path d="M239.525752,116.998677 L78.6538161,0.61431818" stroke="#6ECDF5"></path><path d="M16.3120027,125.946118 L78.6538161,0.61431818" stroke="#6ECDF5"></path><path d="M15.6568751,125.27333 L43.1256029,182.634752" stroke="#E60433"></path><path d="M43.1256029,182.634752 L200.909747,6.01962679" stroke="#E60433"></path><path d="M15.6568751,125.27333 L200.909747,6.01962679" stroke="#E60433"></path><path d="M15.6568751,125.27333 L221.975051,144.339786" stroke="#E60433"></path><path d="M200.909747,6.01962679 L221.975051,144.339786" stroke="#E60433"></path><path d="M221.975051,144.339786 L242.948866,114.17657" stroke="#E60433"></path><path d="M242.948866,114.17657 L73.0003868,18.307288" stroke="#E60433"></path><path d="M15.6568751,125.27333 L73.0003868,18.307288" stroke="#E60433"></path></g></g></g></svg></div>
                    <span>
                        <a class="lab-logo" href="http://lab.technologiestiftung-berlin.de">Ideation&nbsp;&amp; Prototyping&nbsp;Lab</a><br />
                        <a href="http://www.technologiestiftung-berlin.de">Technologiestiftung Berlin</a>
                    </span>
                </div>
                <div class="right">
                    <nav id="page-nav">
                        <ul>
                            <li><a href="http://lab.technologiestiftung-berlin.de">Zurück zum Lab</a>&nbsp;<span class="arrow">&#8614;</span></li>
                            <li class="lang"><a href="http://lab.technologiestiftung-berlin.de/projects/funding/index_en.html">English</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </header>
        <main>
            <div id="title">
                <div class="container">
                    <span class="button tag">Datenvisualisierung</span>
                    <h1>Berliner Zuwendungsdaten visualisiert</h1>
                    <span class="title-subline">Fabian Dinklage (<a href="https://twitter.com/fdnklg">@fdnklg</a>) | 02/2018</span>
                </div>
            </div>

            <!-- Start editing here -->

            <div class="container p-bottom">
                <p class="copy">Lorem ipsum dolor sit <i>amet</i>, <strong>consectetuer</strong> adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa. <a href="#">Cum sociis natoque penatibus</a> et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim. Donec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim justo, rhoncus ut, imperdiet a, venenatis vitae, justo. Nullam dictum felis eu pede mollis pretium. Integer tincidunt. Cras dapibus. Vivamus elementum semper nisi. Aenean vulputate eleifend tellus. Aenean leo ligula, porttitor eu, consequat vitae, eleifend ac, enim. Aliquam lorem ante, dapibus in, viverra quis, feugiat a, tellus.</p>
						</div>


						<div class="container p-bottom p-top m-width flex flex-row">

							<h3>Wie diese Visualisierung zu lesen ist:</h3>

								<div class="btn-group flex flex-col">
									<a id="btn_money_abs" class="button">Alle Zuwendungen in €</a>
									<a id="btn_count_abs" class="button">Anzahl der Zuwendungen</a>
								</div>

								<div class="btn-group flex flex-col">
									<a id="btn_money_rel" class="button">Zuwendungen pro Jahr in %</a>
									<a id="btn_count_rel" class="button">Anzahl d. Zuwendungen pro Jahr in %</a>
								</div>

						</div>

						<div id="legend" class="container m-width p-top p-bottom">
							<h3 id="legend-title"></h3>
						</div>
						<div class="vis container p-bottom"><div id="chart"></div>

            <div class="container p-bottom">
                <p class="copy">Lorem ipsum dolor sit <i>amet</i>, <strong>consectetuer</strong> adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa. <a href="#">Cum sociis natoque penatibus</a> et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim. Donec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim justo, rhoncus ut, imperdiet a, venenatis vitae, justo. Nullam dictum felis eu pede mollis pretium. Integer tincidunt. Cras dapibus. Vivamus elementum semper nisi. Aenean vulputate eleifend tellus. Aenean leo ligula, porttitor eu, consequat vitae, eleifend ac, enim. Aliquam lorem ante, dapibus in, viverra quis, feugiat a, tellus.</p>
                <blockquote>
                    <p>
                        Open Data ist schon ne richtig feine Sache.
                    </p>
                    <span class="author">Sagt der Ben</span>
                </blockquote>
                <p class="copy">Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget dolor. Aenean massa. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque eu, pretium quis, sem. Nulla consequat massa quis enim. Donec pede justo, fringilla vel, aliquet nec, vulputate eget, arcu. In enim justo, rhoncus ut, imperdiet a, venenatis vitae, justo. Nullam dictum felis eu pede mollis pretium.</p>
               
            </div>

            <div class="container small center">
                <a class="lghtbx" title="Image Title 5" href="images/mindcraft.jpg"><img src="images/mindcraft_thumb.jpg" alt="Thumbnail 5" /></a>
			</div>
			

            <div class="container p-top">
                <ul class="download-list">
                    <li>
                        <a href="#">
                            <span class="download-icon"></span>
                            <span class="download-title">Datei XY Integer tincidunt. Cras dapibus. Vivamus elementum.</span><br />
                            <span class="download-subtitle">20 MB, 10/2017</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <span class="download-icon"></span>
                            <span class="download-title">Datei XY</span><br />
                            <span class="download-subtitle">20 MB, 10/2017</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <span class="download-icon"></span>
                            <span class="download-title">Datei XY</span><br />
                            <span class="download-subtitle">20 MB, 10/2017</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <span class="download-icon"></span>
                            <span class="download-title">Datei XY</span><br />
                            <span class="download-subtitle">20 MB, 10/2017</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="container center">
                <a id="github" href="https://github.com/technologiestiftung/{{PROJECT}}">
                    <img src="../../images/github.svg" alt="Project on Github" />
                    <span class="github-title">technologiestiftung/{{PROJECT}}</span><br />
                    <span class="github-subline">Projekt auf GitHub</span>
                    <hr class="clear" />
                </a>
            </div>

            <div id="author" class="container small p-top">
                <img src="../../images/team/author_fabiandinklage.png" alt="Fabian Dinklage" />
                <h3>Über den Autor</h3>
                <h2><a href="maito:dinklage@technologiestiftung-berlin.de">Fabian Dinklage</a></h2>
                <p>...</p>
                <hr class="clear" />
            </div>

            <div id="tooltip">
							<div class="tooltip--title">
								<span>Sektor</span>
								<h3 id="category_title"></h3>
							</div>
							<div class="tooltip--title p-top-m">
								<span>Jahr</span>
								<h3 id="date"></h3>
							</div>
							<div class="tooltip--title p-top-xs">
								<span>Volumen</span>
								<h3 id="money_value"></h3>
							</div>
							<div class="tooltip--title p-top-xs">
								<span>Anzahl d. Zuwendungen</span>
								<h3 id="count_value">Kategorie Name</h3>
							</div>
							
							<span id="money_value"></span>
						</div>

        </main>
        <footer id="contact">
            <div id="footer">
                <div class="container">
                    <a href="http://www.technologiestiftung-berlin.de"><img src="../../images/tsb-logo.png" alt="Technologiestiftung Berlin" /></a>
                    <div class="contact-meta">
                        Grunewaldstraße 61-62<br />
                        10825 Berlin<br />
                        +49 30 209 69 99-0<br />
                        <a href="mailto:info@technologiestiftung-berlin.de">info@technologiestiftung-berlin.de</a>
                    </div>
                    <div class="contact-social">
                        <a href=""><img src="../../images/twitter.png" alt=""></a>
                        <a href=""><img src="../../images/facebook.png" alt=""></a>
                    </div>
                </div>
            </div>
            <div id="end">
                <div class="container">
                    <div class="left">© Technologiestiftung Berlin 2017</div>
                    <div class="right">
                        <a href="https://www.technologiestiftung-berlin.de/de/stiftung/kontakt-anfahrt/" target="_blank">Kontakt</a>
                        &nbsp;|&nbsp;
                        <a href="https://www.technologiestiftung-berlin.de/de/impressum" target="_blank">Impressum</a>
                        &nbsp;|&nbsp;
                        <a href="https://www.technologiestiftung-berlin.de/de/datenschutz/" target="_blank">Datenschutz</a>
                    </div>
                </div>
            </div>
        </footer>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="../../js/prism/prism.js"></script>
        <script type="text/javascript" src="../../js/min/logo.min.js"></script>
				<script type="text/javascript" src="../../js/min/script.min.js"></script>
				



        <!-- Add your custom JS files here and place them directly in your project folder -->
        <script type="text/javascript">
					Number.prototype.map = function (in_min, in_max, out_min, out_max) {
						return (this - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
					}

					function relative(share, total, decimal) {
						return Math.abs(((share / total) * 100).toFixed(decimal));
					}

					function numberFormat(num) {
						var y = num.toString().split('.');
						if(num > 9999) {y[0] = y[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');}
						return y.join(',');
					}

					var Chart = (function(window, d3) {

						var svg, chartWrapper, category, circle, values, logValueScale, data, margin, sector, circleGroup, categories, labelsYear, marker, label, countMinMax, svgLegend, labelYear, xAxis, xScale, x, tooltip, swoopyArrow
						
						var categoryTitles = [];
						var idCircle = 1;
						var idCircle2 = 1;
						var countY = 1;
						var years = [2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016];

						var margin = {
							top: 50,
							bottom: 150,
							left: 50,
							right: 50
						}

						var antns = {
								moneyRelative: [
									{
										pos: [15, 127],
										content: [
											'Mehr als 60% aller Zu-',
											'wendungen fließen in die ',
											'Baustelle des BER Flughafens.'
										]
									},
									{
										pos: [250, 560, 200, 525],
										content: [
											'Dies ist ein Dummytext',
											'der über mehrere Zeilen',
											'verläuft.'
										]
									},
								],
								moneyAbsolute: [
									{
										pos: {
											start: 25,
											end: 75
										},
										content: [
											'Mehr als 60% aller Zu-',
											'wendungen fließen in die ',
											'Baustelle des BER Flughafens.'
										]
									},
									{
										pos: {
											start: 127,
											end: 164
										},
										content: [
											'Die Zuwendungen im Bereich',
											'Integration haben sich',
											'im Vergleich zum Vorjahr',
											'mehr als ver 17facht.'
										]
									},
								],
								countRelative: [
									{
										pos: [850, 260, 700, 125],
										content: [
											'Dies ist ein Dummytext',
											'der über mehrere Zeilen',
											'verläuft.'
										]
									},
									{
										pos: [250, 560, 200, 525],
										content: [
											'Dies ist ein Dummytext',
											'der über mehrere Zeilen',
											'verläuft.'
										]
									},
								],
								countAbsolute: [
									{
										pos: [800, 100, 460, 325],
										content: [
											'Dies ist ein Dummytext',
											'der über mehrere Zeilen',
											'verläuft. Diesmal sind es',
											'sogar vier Zeilen.'
										]
									},
									{
										pos: [650, 360, 400, 225],
										content: [
											'Dies ist ein Dummytext',
											'der über mehrere Zeilen',
											'verläuft.'
										]
									},
								],
						}
						
						var config = {
							svg: {
								width: 1000,
								height: 1200,
								maxRad: 100,
								minRad: 2
							},
							data: {
								relative: true
							}
						}

						var legendTitle = {
							moneyAbsolute: 'Der Kreisradius bildet das Volumen aller Zuwenungen in € ab.',
							moneyRelative: 'Der Kreisradius bildet %-ualen Anteil aller Zuwendungen in € / Jahr ab.',
							countRelative: 'Der Kreisradius bildet %-ualen Anteil der Anzahl aller Zuwendungen / Jahr ab.',
							countAbsolute: 'Der Kreisradius bildet Anzahl aller Zuwendungen / Jahr ab.'
						}


						var legendPos = {
							moneyAbsolute: [
								{ pos: 100, content: '2.025.361.267 Billion €' },
								{ pos: 75, content: '1.519.020.950 Billion €' },
								{ pos: 50, content: '1.012.680.633 Milliare €' },
								{ pos: 25, content: '506.340.316 Millionen €' }
							],
							moneyRelative: [
								{ pos: 100, content: '25%' },
								{ pos: 75, content: '50%' },
								{ pos: 50, content: '75%' },
								{ pos: 25, content: '100%' }
							],
							countAbsolute: [
								{ pos: 100, content: '1229 Zuwendungen' },
								{ pos: 75, content: '2459 Zuwendungen' },
								{ pos: 50, content: '3688 Zuwendungen' },
								{ pos: 25, content: '4917 Zuwendungen' }
							],
							countRelative: [
								{ pos: 100, content: '25%' },
								{ pos: 75, content: '50%' },
								{ pos: 50, content: '75%' },
								{ pos: 25, content: '100%' }
							],
						}

						var swoopy = swoopyArrow()
							.angle(Math.PI/4)
							.x(function(d) { return d[0]; })
							.y(function(d) { return d[1]; });

						d3.json('data/politikbereich.json', init);
						
						function init(json) {
							data = json;

							var dataAllYears = [];

							data.forEach( category => {
								categoryTitles.push(category.target);

								category.years.forEach( year => {
									dataAllYears.push(year);
								})
							})
							var countAllYears = [];
							var moneyAllYears = [];

							dataAllYears.forEach( year => {
								moneyAllYears.push(year.money);
								countAllYears.push(year.count);
							} )

							chartWrapper = d3.select('#chart')
							legendWrapper = d3.select('#legend')

							countMinMax = d3.extent(countAllYears);

							moneyMinMax = d3.extent(moneyAllYears);
							countMinMax = d3.extent(data, d => { return d.count });

							x = d3.extent(years);

							xScale = d3.scaleLinear()
								.domain(x)
								.range([0, config.svg.width - margin.left - margin.right]);

							xAxis = d3.axisBottom(xScale).ticks(8).tickFormat(d3.format("d"));;

							renderLegend('moneyAbsolute');

							wrapperText = chartWrapper
								.append('div')
								.classed('labels', true)
								
							
							wrapperText.selectAll('sectorLabel')
								.data(data)
								.enter()
								.append('p')
								.classed('copy xs label', true)
								.attr('id', (d,i) => { 
									return `label-${i + 1}` })
								.attr('style', 'width: 150px')
								.text((d) => { return d.target; });
										
							svg = chartWrapper
								.append('svg')
								.attr('id', 'svg-wrapper')
								.attr('width', config.svg.width)
								.attr('height', config.svg.height)
							
							svg.append('g').classed('x axis', true);

							svg.select('.x.axis')
								.append('g')
								.attr('transform', `translate(${margin.left}, 0)`)
								.call(xAxis)
								
							marker = svg
								.append('marker')
								.attr('id', 'arrowhead')
								.attr('viewBox', '-10 -10 20 20')
								.attr('refX', 0)
								.attr('refY', 0)
								.attr('markerWidth', 20)
								.attr('markerHeight', 20)
								.attr('stroke-width', 1)
								.attr('orient', 'auto')
							
							marker
								.append('polyline')
								.attr('stroke-linejoin', 'bevel')
								.attr('points', '-6.75,-6.75 0,0 -6.75,6.75')

							category = svg.selectAll('chartCategory')
								.data(data)
								.enter()
								.append('g')
								.classed('category', true)
							
							circleGroup = category.selectAll('circles')
								.data((d) => { return d.years })
								.enter()
								.append('g')
								.classed('circle', true)

							circle = circleGroup
								.append('circle')
								.attr('data-uid', (d,i) => {
									if(i === 7) { idCircle2 += 1 };
									var uid = `${idCircle2}${i}`;

									return uid;
								})
								.attr('id', (d,i) => { 
									if(i === 7) { idCircle += 1 };
									return `${idCircle}`; 
									})
								.classed('value', true)
								.attr('data-year', (d,i) => {
									return i
								})
								.attr('r', (d) => {
									var value = d.money.map(moneyMinMax[0], moneyMinMax[1], config.svg.minRad, config.svg.maxRad);
									if(d.money === 0) { return 0 };
									return value;
								})
								.on('mouseover', handleMouseOver)
								.on('mouseout', handleMouseOut)
						
							render();
						}

						function renderLegend(view) {
							d3.select('.legend-wrapper').remove();

							var title = d3.select('#legend-title');							
							title.text(legendTitle[view]);
							
							svgLegend = legendWrapper
								.append('svg')
								.classed('legend-wrapper', true)
								.attr('height', 120)
								.attr('width', 700)

							svgLegend.selectAll('circles')
								.data(legendPos[view])
								.enter()
								.append('circle')
								.attr('cx', 0)
								.attr('cy', 120)
								.attr('r', d => { return d.pos })
							
							svgLegend.selectAll('lines')
								.data(legendPos[view])
								.enter()
								.append('line')
								.attr('x1', 0)
								.attr('y1', d => { return d.pos - 4 })
								.attr('x2', 120)
								.attr('y2', d => {return d.pos - 4})
								.attr('stroke-width', 1)
								.attr('stroke','black')
								.classed('legend-line', true)
								
							svgLegend.selectAll('annotations')
								.data(legendPos[view])
								.enter()
								.append('text')
								.classed('annotation', true)
								.attr('x', 125)
								.attr('y', d => { return d.pos})
								.text(d => {return d.content})	
						}

						function render() {

							var countY = 1;

							var chartSizes = document.getElementById('svg-wrapper').getBoundingClientRect();
							var chartWrapper = document.getElementById('chart').getBoundingClientRect();
							var labels = document.querySelector('.labels').getBoundingClientRect();
							var newWidth = chartWrapper.width - labels.width;

							config.svg.width = newWidth;
							
							
							updatePositions();
						}
						
						function resize(winWidth) {
							config.svg.width = winWidth;
							config.svg.height = 1200 - margin.top - margin.bottom;
						}

						function updatePositions() {
							var countY = 1;
							var newWidth = config.svg.width - margin.left - margin.right;

							svg
								.attr('width', config.svg.width)
								.attr('height', config.svg.height)
							
							circle
								.attr('cx', (d,i) => { 
									var posX = ((newWidth / (years.length - 1)) * i + 1);
									return posX;
								})
								.attr('cy', (d,i) => { 
									if (i === 7) { countY += 1 }
									return (((config.svg.height - margin.top - margin.bottom) / 31) * countY)
								})

							xScale.range([0, newWidth]);
							xAxis.scale(xScale);

							svg.select('.x.axis')
								 .call(xAxis)
								
							category.attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');
						}

						function handleMouseOut() {
							d3.select(this)
								.classed('active', false)

							var id = d3.select(this).attr('id');
							d3.select(`#label-${id}`).classed('label-active', false);

							tooltip.style('display', 'none');

						}

						function handleMouseOver(d, i) {
							d3.select(this)
								.classed('active', true)

							var id = d3.select(this).attr('id');

							d3.select(`#label-${id}`).classed('label-active', true)

							updateTooltip(d, this);
						}

						function updateTooltip(d, that) {
							

							tooltip = d3.select('#tooltip')
							tooltip.style('display', 'block');

							var x = d3.event.pageX + 10
							var y = d3.event.pageY + 10

							tooltip
								.style('left', `${x}px`)
								.style('top', `${y}px`)
							

							var count = d3.select('#count_value');
							var money = d3.select('#money_value');
							var date = d3.select('#date');
							var category = d3.select('#category_title');

							var yearId = d3.select(that).attr('data-year');
							var categoryId = d3.select(that).attr('id');

							category.text(categoryTitles[categoryId - 1]);
							date.text(years[yearId]);
							count.text(`${numberFormat(d.count)}`);
							money.text(`${numberFormat(d.money)} € (${d.moneyShare}%)`);
						}

						d3.select('#btn_money_abs').on('click', () => {
							var btn = d3.select(this);
							updateMoneyAbs();
							chooseSwoopy('moneyAbsolute');
							renderLegend('moneyAbsolute');
						});

						d3.select('#btn_money_rel').on('click', () => {
							var btn = d3.select(this);
							chooseSwoopy('moneyRelative');
							updateMoneyRel();
							renderLegend('moneyRelative');
						});

						d3.select('#btn_count_rel').on('click', () => {
							var btn = d3.select(this);
							updateCountRel();
							chooseSwoopy('countRelative');
							renderLegend('countRelative');
						});

						d3.select('#btn_count_abs').on('click', () => {
							var btn = d3.select(this);
							updateCountAbs();
							chooseSwoopy('countAbsolute');
							renderLegend('countAbsolute');
						});

						function updateCountAbs() {
							circle
									.transition()
									.duration(750)
									.attr('r', (d) => {
										var value = d['count'].map(countMinMax[0], countMinMax[1], config.svg.minRad, config.svg.maxRad)
										if(d.count === 0) { return 0 };
										return value;
									})
									.attr('class', 'circle-count')
						}

						function updateCountRel() {
							circle
								.transition()
								.duration(750)
								.attr('r', (d) => {
									var value = d['countShare'].map(0, 100, config.svg.minRad, config.svg.maxRad)
									if(d.countShare === 0) { return 0 };
									return value;
								})
								.attr('class', 'circle-count')
						}

						function updateMoneyRel() {
							circle
								.transition()
								.duration(750)
								.attr('r', (d) => {
									var value = d['moneyShare'].map(0, 100, config.svg.minRad, config.svg.maxRad);

									if(d.moneyShare === 0) { return 0 };
									return value;
								})
								.attr('class', 'circle-count')
						}

						function updateMoneyAbs() {
							circle
								.transition()
								.duration(750)
								.attr('r', (d) => {
									var value = d['money'].map(moneyMinMax[0], moneyMinMax[1], config.svg.minRad, config.svg.maxRad);

									if(d.money === 0) { return 0 };
									return value;
								})
								.attr('class', 'circle-money')
						}

						function chooseSwoopy(swoopyId) {

							d3.selectAll('.annotation').remove();
							d3.selectAll('.arrow').remove();

							renderSwoopy(swoopyId);
						}

						function renderSwoopy(view) {

							antns[view].forEach( annotation => {

								var posX1 = d3.select(`circle[data-uid='${annotation.pos.start}']`).attr('cx');
								var posX2 = d3.select(`circle[data-uid='${annotation.pos.end}']`).attr('cx');
								var posY1 = d3.select(`circle[data-uid='${annotation.pos.start}']`).attr('cy');
								var posY2 = d3.select(`circle[data-uid='${annotation.pos.end}']`).attr('cy');

								svg
									.append('circle')
									.attr('r', 10)
									.attr('fill', 'black')
									.attr('cx', posX1)
									.attr('cy', posY1)

								// console.log(posX2, margin.left)

								swoopyArrow = svg.append("path")
									.attr('class', 'arrow')
									.attr('marker-end', 'url(#arrowhead)')
									.datum([[posX2, posY2], [posX1 , posY1]])
									.attr("d", swoopy);
								
								var text = svg
									.append("text")
									.classed('annotation', true)
									.attr('x', posX2 + 10)
									.attr('textLength', 200)
									.attr('y', posY2 + 10)
								
								text.selectAll('tSpan')
									.data(annotation.content)
									.enter()
									.append('tspan')
									.attr('x', posX2 + 10)
									.attr('dy', (d,i) => { 
										var lineHeight = 1.2; 
										return `${lineHeight}rem` ;
									})
									.text( d => { return d })
								}) 
						}

						function swoopyArrow() {

							var angle = Math.PI,
								clockwise = true,
								xValue = function(d) { return d[0]; },
								yValue = function(d) { return d[1]; };

							function render(data) {

							data = data.map(function(d, i) {
								return [xValue.call(data, d, i), yValue.call(data, d, i)];
							});

							// get the chord length ("height" {h}) between points
							var h = hypotenuse(data[1][0]-data[0][0], data[1][1]-data[0][1])

							// get the distance at which chord of height h subtends {angle} radians
							var d = h / ( 2 * Math.tan(angle / 2) );

							// get the radius {r} of the circumscribed circle
							var r = hypotenuse(d, h/2)

							var path =  "M " + data[0][0] + "," + data[0][1]
								+ " a " + r + "," + r
								+ " 0 0," + (clockwise ? "1" : "0") + " "
								+ (data[1][0]-data[0][0]) + "," + (data[1][1]-data[0][1]);

							return path
							}

							function hypotenuse(a, b) {
							return Math.sqrt( Math.pow(a,2) + Math.pow(b,2) );
							}

							render.angle = function(_) {
							if (!arguments.length) return angle;
							angle = Math.min(Math.max(_, 1e-6), Math.PI-1e-6);
							return render;
							};

							render.clockwise = function(_) {
							if (!arguments.length) return clockwise;
							clockwise = !!_;
							return render;
							};

							render.x = function(_) {
							if (!arguments.length) return xValue;
							xValue = _;
							return render;
							};

							render.y = function(_) {
							if (!arguments.length) return yValue;
							yValue = _;
							return render;
							};

							return render;
							}

						window.addEventListener('resize', (event) => {
							render();
						})

					})(window,d3);
        </script>
    </body>
</html>